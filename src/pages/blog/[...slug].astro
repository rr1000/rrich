---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

function daysAgo(date: Date): number {
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  return Math.floor(diff / (1000 * 60 * 60 * 24));
}

const { post } = Astro.props;
const { Content } = await render(post);
---

<BaseLayout title={`${post.data.title} - Ryan Rich`}>
  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox">
    <button class="lightbox-close" aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <img id="lightbox-img" src="" alt="" />
  </div>

  <div class="flex justify-start mb-4">
    <button 
      id="toggle-align" 
      class="text-[var(--color-text)] hover:text-[var(--color-heading)] transition-colors border border-[var(--color-border)] p-2 rounded cursor-pointer"
      title="Toggle alignment"
    >
      <!-- align-center-vertical-simple (vertical line with horizontal arrows pointing in) -->
      <svg id="icon-center" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256" class="hidden">
        <path d="M128,32a8,8,0,0,1,8,8V216a8,8,0,0,1-16,0V40A8,8,0,0,1,128,32ZM64,120H44.94l17.53-17.53a8,8,0,0,0-11.31-11.31l-32,32a8,8,0,0,0,0,11.31l32,32a8,8,0,0,0,11.31-11.31L44.94,136H64a8,8,0,0,0,0-16Zm172.84,2.83-32-32a8,8,0,0,0-11.31,11.31L211.06,120H192a8,8,0,0,0,0,16h19.06l-17.53,17.53a8,8,0,0,0,11.31,11.31l32-32A8,8,0,0,0,236.84,122.83Z"/>
      </svg>
      <!-- align-left-simple (vertical line on left with horizontal line) -->
      <svg id="icon-left" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256" class="block">
        <path d="M48,40V216a8,8,0,0,1-16,0V40a8,8,0,0,1,16,0ZM88,120H216a8,8,0,0,1,0,16H88a8,8,0,0,1,0-16Z"/>
      </svg>
    </button>
  </div>
  <article id="article-container" class="transition-all duration-300 max-w-[85ch] mx-auto">
    <header class="mb-8">
      <p class="text-[length:var(--text-size)] uppercase mb-2">POSTED: {daysAgo(post.data.date)} DAYS AGO</p>
      <h1 class="text-[var(--color-heading)] text-[length:var(--text-size)] font-medium tracking-wide uppercase">{post.data.title}</h1>
    </header>
    <div class="prose max-w-[85ch]
      prose-headings:text-[var(--color-heading)] prose-headings:text-[length:var(--text-size)] prose-headings:uppercase prose-headings:tracking-wide
      prose-p:text-[var(--color-text)] prose-p:text-[length:var(--text-size)] prose-p:leading-relaxed
      prose-li:text-[var(--color-text)] prose-li:text-[length:var(--text-size)]
      prose-a:text-[var(--color-text)] prose-a:underline hover:prose-a:text-[var(--color-heading)]
      prose-strong:text-[var(--color-heading)]">
      <Content />
    </div>
  </article>
  <div id="back-link" class="mt-12 pt-8 border-t border-[var(--color-border)] transition-all duration-300 max-w-[85ch] mx-auto">
    <a href="/blog" class="text-[length:var(--text-size)] uppercase hover:text-[var(--color-heading)] transition-colors">‚Üê Back to writing</a>
  </div>
</BaseLayout>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById('toggle-align');
    const article = document.getElementById('article-container');
    const backLink = document.getElementById('back-link');
    const iconCenter = document.getElementById('icon-center');
    const iconLeft = document.getElementById('icon-left');
    
    let isCentered = true;

    if (button) {
      button.addEventListener('click', () => {
        isCentered = !isCentered;
        
        if (isCentered) {
          article.style.maxWidth = '';
          article.style.marginLeft = '';
          article.style.marginRight = '';
          backLink.style.maxWidth = '';
          backLink.style.marginLeft = '';
          backLink.style.marginRight = '';
          iconCenter.classList.add('hidden');
          iconCenter.classList.remove('block');
          iconLeft.classList.add('block');
          iconLeft.classList.remove('hidden');
        } else {
          article.style.maxWidth = 'none';
          article.style.marginLeft = '0';
          article.style.marginRight = '0';
          backLink.style.maxWidth = 'none';
          backLink.style.marginLeft = '0';
          backLink.style.marginRight = '0';
          iconCenter.classList.add('block');
          iconCenter.classList.remove('hidden');
          iconLeft.classList.add('hidden');
          iconLeft.classList.remove('block');
        }
      });
    }

    // Lightbox functionality
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxClose = document.querySelector('.lightbox-close');
    const proseImages = document.querySelectorAll('.prose img');

    proseImages.forEach(img => {
      img.addEventListener('click', () => {
        lightboxImg.src = img.src;
        lightboxImg.alt = img.alt;
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
      });
    });

    function closeLightbox() {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    }

    lightbox.addEventListener('click', closeLightbox);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && lightbox.classList.contains('active')) {
        closeLightbox();
      }
    });
  });
</script>
